# Box2d

[toc]

box2d是用于游戏的2D刚体仿真库。程序员可以在游戏中使用它来使对象以逼真的方式移动，并使游戏世界更具有交互性。从游戏引擎的角度来看，物理引擎只是用于过程动画的系统。

## 核心概念

### 形状（shape）

形狀是2D几何对象，例如圆形或者多边形。

### 刚体（rigid body）

一块物质如此强大，以至于该物质上任何两小块之间的距离都是恒定的。 他们像钻石一样坚硬。 在下面的讨论中，我们将刚体与刚体互换使用。

### 固定装置（fixture)

固定装置将形状绑定到身体，并增加了诸如密度，摩擦力和恢复性之类的材料属性。 固定装置将一个形状放入碰撞系统（网格）中，以便它可以与其他形状碰撞。

### 约束（constraint）

约束是一种物理连接，它消除了物体的自由度。 2D物体具有3个自由度（两个平移坐标和一个旋转坐标）。 如果我们将一个物体固定在墙上（如钟摆），则将其约束在墙壁上。 此时，主体只能绕点旋转，因此约束已消除了2个自由度。

### 接触约束（contact constraint）

一种特殊的约束，旨在防止刚体穿透并模拟摩擦和恢复原状。 你不用创建联系约束。 它们由Box2D自动创建。

### 关节（joint）

这是用于将两个或多个实体结合在一起的约束。 Box2D支持多种关节类型：旋转，棱柱形，距离等。 关节可以支持限制（limit）和马达（motors）。

### 关节限制（joint limit）

一个关节限制(joint limit)限定了一个关节的运动范围。例如人类的胳膊肘只能做某一范围角度的运动。

### 马达关节（joint  motor）

一个关节马达能依照关节的自由度来驱动所连接的物体。例如，你可以使用一个马达来驱动一个肘的旋转。

### 世界（world）

一个物理世界就是物体，形状和约束相互作用的集合。Box2D 支持创建多个世界，但这通常是不必要的。 

### 求解器（solver）

物理世界有一个求解器，该求解器用于延长时间并解决接触约束和联合约束。 Box2D求解器是一种高性能的迭代求解器，它以N次的顺序运行，其中N是约束的数量。

### 持续碰撞（continuous collision）

求解器使用不连续的时间步长按时间顺序推进实体。 没有干预，这可能会导致隧穿（穿过碰撞体，导致没有发生碰撞检测）。

Box2D包含用于处理隧道的专用算法。 首先，碰撞算法可以对两个物体的运动进行插值，以得出首次碰撞时间（TOI）。 其次，有一个分步求解器，可将物体移到其第一次撞击时，然后解决碰撞。

## 模块

box2d由三个模块组成：Common、Collision和Dynamics。Common模块负责分配、数学和设置。Collision模块定义了形状、网格以及碰撞功能和查询。Dynamics（动力学）模块提供模拟世界、物体、固定以及关节。

## 单元

Box2D使用浮点数，并且必须使用公差才能使Box2D表现良好。 这些公差已经过调整，可以与米-千克-秒（MKS）单位一起很好地工作。 特别是，Box2D已经过调整，可以在0.1到10米之间移动形状时很好地工作。 因此，这意味着汤罐和公共汽车之间的物体应能正常工作。 静态形状可能长达50米而没有麻烦。

> 公差数值选择的基本原则是：应使机器零件制造成本和使用价值的综合经济效果最好。

作为2D物理引擎，以像素为单位很诱人。 不幸的是，这将导致较差的仿真并可能产生奇怪的行为。 Box2D会将长度为200像素的对象视为45层建筑物的大小。

> 警告：Box2D已针对MKS单位进行了调整。 保持移动物体的大小大约在0.1至10米之间。 渲染环境和角色时，需要使用一些缩放系统。 Box2D测试平台通过使用OpenGL视口转换来实现此目的。 请勿使用像素。

最好将Box2D实体视为在其上附加艺术品的移动广告牌。 广告牌可能以米为单位移动，但是您可以使用简单的比例因子将其转换为像素坐标。 然后，您可以使用这些像素坐标放置精灵等。您还可以考虑坐标轴的翻转。

要考虑的另一个限制是整个世界的大小。 如果您的世界单位变得大于2公里左右，那么丢失的精度可能会影响稳定性。

如果需要更大的游戏世界，请考虑使用`b2World :: ShiftOrigin`来使世界起源靠近您的玩家。 我建议使用网格线以及一些滞后来触发对`ShiftOrigin`的调用。 不应频繁进行此调用，因为它具有CPU开销。 在游戏单位和Box2D单位之间进行转换时，可能需要存储物理偏移。

Box2D使用弧度表示角度。 身体旋转以弧度存储，并且可能会无限增长。 如果角度的大小变得太大，请考虑将身体的角度归一化（使用`b2Body :: SetTransform`）。

## 改变网格长度

高级用户可以通过`b2_lengthUnitsPerMeter`改变网格长度。可以通过定义`B2_USER_SETTINGS`并提供`b2_user_settings.h`来避免合并冲突。 有关详细信息，请参见文件`b2_settings.h`。

## 工厂和定义

快速的内存管理在Box2D API的设计中起着核心作用。 因此，当您创建b2Body或b2Joint时，您需要在b2World上调用工厂函数。 您永远不要尝试以其他方式分配这些类型。

```c++
b2Body* b2World::CreateBody(const b2BodyDef* def)
b2Joint* b2World::CreateJoint(const b2JointDef* def)
    
void b2World::DestroyBody(b2Body* body)
void b2World::DestroyJoint(b2Joint* joint)
```



## Box2D Hello World

在Box2D发行版中是一个Hello World项目。 该程序将创建一个大型接地箱和一个小型动态箱。 此代码不包含任何图形。 您将看到的是随时间推移在框位置的控制台中输出的文本。

这是如何使用Box2D并运行它的一个很好的例子。

### 创建一个物理世界

每个Box2D项目都是从创建一个物理世界开始的`b2World object`。`b2World`是管理内存、对象和模拟物理的中心。你可以在堆栈、堆或数据段上分配物理世界。

创建一个box2d世界非常的简单，首先定义一个重力常量。

```c++
b2Vec2 gravity(0.0f, -10.0f);
```

然后创建一个在堆栈上的世界，所以这个世界必须在作用域（scope）内。

```c++
b2World world(gravity);
```

接下来我们往这个世界里面添加点其它东西。

### 创建一个一个地面盒子

一个body的创建需要以下几个步骤：

1. 定义一个body，带有位置和阻尼等物理特性。
2. 使用世界那个物体来创建这个body。
3. 定义一个fixtures带有shape，摩擦力和密度等。

> 阻尼（英语：damping）是指任何振动系统在振动中，由于外界作用（如流体阻力、摩擦力等）和/或系统本身固有的原因引起的振动幅度逐渐下降的特性，以及此一特性的量化表征。

